# 管理者ユーザー管理（追加/変更/削除）

## 目的
- システム管理者がユーザーと組織メンバーを安全に運用できるようにする
- 失敗時の切り分けを明確にする

## 前提
- システム管理者権限のユーザーでログインしている
- `SUPABASE_SERVICE_ROLE_KEY` が設定済み
- 招待メール方式はSMTP設定が必要（未設定なら招待リンクを使う）

## ユーザー作成（招待メール）
1) `/admin/users` を開く  
2) **メールアドレス** を入力  
3) **作成方式** を「招待メール」に選択  
4) **ユーザーを作成** をクリック  
5) 画面に「招待メールを送信しました。」が表示される  

## ユーザー作成（招待リンク）
1) `/admin/users` を開く  
2) **メールアドレス** を入力  
3) **作成方式** を「招待リンク」に選択  
4) **ユーザーを作成** をクリック  
5) 画面に **招待リンク** が表示される  
6) リンクを安全な手段で共有する（漏洩注意）  

## 招待テンプレ（件名/本文のコピー）
1) `/admin/users` を開く  
2) **招待テンプレ** セクションを開く  
3) **組織名** を確認/入力  
4) **招待リンク** を貼り付け（または「直近の招待リンクを反映」）  
5) **任意メッセージ** を入力（任意）  
6) **件名をコピー / 本文をコピー** を押して共有する  

### テンプレ例（運用統一）
- 件名  
  - `【TEPPEN MEO】{組織名} 招待のご案内`
- 本文  
  - `TEPPEN MEOへの招待をご案内します。`  
  - `{組織名}の運用メンバーとして招待されています。`  
  - `以下の招待リンクから登録してください。`  
  - `招待リンク: {招待リンク}`  
  - `管理者メッセージ: {任意メッセージ}`  
  - `※リンクは第三者に共有しないでください。`  
  - `※リンクが無効な場合は管理者に連絡してください。`  

## ユーザー作成（仮パスワード）
1) `/admin/users` を開く  
2) **メールアドレス** を入力  
3) **作成方式** を「仮パスワード」に選択  
4) **ユーザーを作成** をクリック  
5) 「仮パスワード（この画面でのみ表示）」が表示される  
6) パスワードを安全な手段で本人に共有し、初回ログイン後に変更するよう案内する  

## ユーザー無効化
1) `/admin/users` を開く  
2) 対象ユーザーの **無効化** を開く  
3) 確認用メールを入力  
4) **無効化理由** を入力（200文字以内）  
5) **利用停止** をクリック  
5) 状態が「無効」になることを確認する  

### 無効化理由のガイドライン
- 機密情報（パスワード/トークン/個人情報）は書かない  
- 例: `利用規約違反のため停止` / `退職のため停止`  

## ユーザー再有効化
1) `/admin/users` を開く  
2) 対象ユーザーの **有効化** をクリック  
3) 状態が「有効」に戻ることを確認する  

## 組織にメンバー追加
1) `/admin/organizations` を開く  
2) 対象組織の **詳細へ** をクリック  
3) **メンバー追加** にメールとロールを入力  
4) **メンバーを追加** をクリック  

## ロール変更
1) `/admin/organizations/<id>` を開く  
2) 対象メンバーの **ロール変更** で新しいロールを選択  
3) **変更** をクリック  

## メンバー削除
1) `/admin/organizations/<id>` を開く  
2) 対象メンバーの **削除** をクリック  
3) 反映を確認する  

## ユーザー削除（危険操作）
1) `/admin/users` を開く  
2) 対象ユーザーの **削除** を開く  
3) 確認用メールを入力  
4) **完全削除** をクリック  
5) 一覧から消えたことを確認する  

## 失敗時の切り分け

### 権限不足
- 管理画面へアクセスできない場合  
  - `system_admins` にユーザーが登録されているか確認（内部テーブル）

### Supabase未設定
- 「Supabaseが未設定のため操作できません」と表示される  
  - `.env.local` に `SUPABASE_SERVICE_ROLE_KEY` を追加
  - URL/キーの整合性を確認

### 招待メールが届かない
- SMTP設定が未完了の可能性  
  - 招待リンクを生成して共有する

### 招待リンクが生成できない
- `SUPABASE_SERVICE_ROLE_KEY` が未設定
- SupabaseのAPI設定（Service Roleキー）が誤り

### 無効化/有効化が失敗する
- `SUPABASE_SERVICE_ROLE_KEY` が未設定
- `supabase/migrations/0002_user_blocks.sql` が未適用  
- まず `docs/runbooks/supabase-migrations.md` を確認  
- SupabaseのRLS/ポリシー設定を確認

### メンバー追加で「対象ユーザーが見つかりません」
- ユーザーが作成済みか確認  
- メールアドレスの入力ミスがないか確認
