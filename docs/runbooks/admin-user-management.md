# 管理者ユーザー管理（追加/変更/削除）

## 目的
- システム管理者がユーザーと組織メンバーを安全に運用できるようにする
- 失敗時の切り分けを明確にする

## 前提
- system_admin 権限のユーザーでログインしている
- `SUPABASE_SERVICE_ROLE_KEY` が設定済み
- 招待メール方式はSMTP設定が必要（未設定なら招待リンクを使う）

## ユーザー作成（招待メール）
1) `/admin/users` を開く  
2) **メールアドレス** を入力  
3) **作成方式** を「招待メール」に選択  
4) **ユーザーを作成** をクリック  
5) 画面に「招待メールを送信しました。」が表示される  

## ユーザー作成（招待リンク）
1) `/admin/users` を開く  
2) **メールアドレス** を入力  
3) **作成方式** を「招待リンク」に選択  
4) **ユーザーを作成** をクリック  
5) 画面に **招待リンク** が表示される  
6) リンクを安全な手段で共有する（漏洩注意）  

## ユーザー作成（仮パスワード）
1) `/admin/users` を開く  
2) **メールアドレス** を入力  
3) **作成方式** を「仮パスワード」に選択  
4) **ユーザーを作成** をクリック  
5) 「仮パスワード（この画面でのみ表示）」が表示される  
6) パスワードを安全な手段で本人に共有し、初回ログイン後に変更するよう案内する  

## ユーザー無効化
1) `/admin/users` を開く  
2) 対象ユーザーの **無効化** を開く  
3) 確認用メールを入力  
4) **利用停止** をクリック  
5) 状態が「無効」になることを確認する  

## ユーザー再有効化
1) `/admin/users` を開く  
2) 対象ユーザーの **有効化** をクリック  
3) 状態が「有効」に戻ることを確認する  

## 組織にメンバー追加
1) `/admin/organizations` を開く  
2) 対象組織の **詳細へ** をクリック  
3) **メンバー追加** にメールとロールを入力  
4) **メンバーを追加** をクリック  

## ロール変更
1) `/admin/organizations/<id>` を開く  
2) 対象メンバーの **ロール変更** で新しいロールを選択  
3) **変更** をクリック  

## メンバー削除
1) `/admin/organizations/<id>` を開く  
2) 対象メンバーの **削除** をクリック  
3) 反映を確認する  

## ユーザー削除（危険操作）
1) `/admin/users` を開く  
2) 対象ユーザーの **削除** を開く  
3) 確認用メールを入力  
4) **完全削除** をクリック  
5) 一覧から消えたことを確認する  

## 失敗時の切り分け

### 権限不足
- 管理画面へアクセスできない場合  
  - `system_admins` にユーザーが登録されているか確認

### Supabase未設定
- 「Supabaseが未設定のため操作できません」と表示される  
  - `.env.local` に `SUPABASE_SERVICE_ROLE_KEY` を追加
  - URL/キーの整合性を確認

### 招待メールが届かない
- SMTP設定が未完了の可能性  
  - 招待リンクを生成して共有する

### 招待リンクが生成できない
- `SUPABASE_SERVICE_ROLE_KEY` が未設定
- SupabaseのAPI設定（Service Roleキー）が誤り

### 無効化/有効化が失敗する
- `SUPABASE_SERVICE_ROLE_KEY` が未設定
- `supabase/migrations/0002_user_blocks.sql` が未適用
- SupabaseのRLS/ポリシー設定を確認

### メンバー追加で「対象ユーザーが見つかりません」
- ユーザーが作成済みか確認  
- メールアドレスの入力ミスがないか確認
