# 監査ログの調査手順

## 目的
- 失敗原因の切り分けと再発防止を素早く行う
- 操作者・対象・時刻を明確にし、運用の再現性を上げる

## 前提
- system_admin 権限でログインしている
- `/admin/audit-logs` にアクセスできる

## よく使うフィルタ（チェックリスト）
- [ ] **Google接続失敗だけ**を見たい  
  - 操作: `プロバイダ接続失敗`  
  - プロバイダ: `Google Business Profile`  
- [ ] **今日の同期失敗だけ**を見たい  
  - 期間（開始/終了）: 今日  
  - 操作: `レビュー同期失敗`  
- [ ] **特定ユーザーがした操作**を見たい  
  - 操作者: `user@example.com`  
- [ ] **特定ロケーションの失敗**を見たい  
  - 自由検索: `loc-xxxx`  

## 失敗時の切り分け（目安）
### 権限不足
- 監査ログに `permission` や `403` が含まれる  
- 対処: API承認/権限申請の状況を確認し、必要な権限を追加

### 再認可が必要
- 操作に `reauth_required` が含まれる  
- 対処: ロケーション詳細の接続画面で再認可

### レート制限
- metadata に `rate limit` / `429` が含まれる  
- 対処: 時間をおいて再実行、または処理間隔を広げる

### マイグレーション未適用
- 無効化/監査関連の操作が失敗する  
- 対処: `docs/runbooks/supabase-migrations.md` を確認して適用

## 注意点
- 監査ログは機密情報を表示しない（トークン/鍵/招待リンクはマスク）
- 自由検索は action/target/metadata の範囲に限定される
