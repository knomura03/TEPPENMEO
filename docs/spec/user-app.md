# ユーザーアプリ仕様（最小版）

## 目的
- テナントユーザーが店舗と連携サービスを操作できること
- 口コミ/投稿の確認と基本操作の導線が分かること

## モック準拠の画面構成（ナビ）
- ダッシュボード / 口コミ・コメント / 投稿（新規・一覧・テンプレ） / 店舗 / 初期設定 / カレンダー（準備中）
- 上位権限ほどメニューが増える（例: 組織管理者はテンプレ管理、システム管理者は運用ツール）
- `/admin` は互換のため残し、ユーザー画面から自然に到達できる導線を作る

## 用語ルール（ユーザー向け表示）
- ロケーション → 店舗（店舗情報）
- プロバイダ → 連携サービス（連携先）
- 接続/連携 → 連携する
- 紐付け → 店舗を選ぶ（連携先を選ぶ）
- レビュー → 口コミ
- モック → デモ（仮データ）
- 実機/本実装 → 本番と同じ仕組み
- 実機スモークテスト → ユーザー画面では表示しない（管理者向けのみ）
- スタブ → 「準備中」「現在は利用できません」に置換する

## 主要画面
- ダッシュボード: `/app`
- 投稿: `/app/posts`
- 初期設定: `/app/setup`
- 店舗一覧: `/app/locations`
- 店舗詳細: `/app/locations/[id]`
- カレンダー: `/app/calendar`（準備中）
- 公開ページ: `/` `/privacy` `/terms` `/data-deletion`（審査用URLとして利用）

## 機能要件

### 店舗（CRUD）
- 作成: 名前は必須、住所/緯度/経度は任意
- 参照: 店舗一覧と詳細の表示
- 更新/削除: 次フェーズで追加
- フォーム/ボタンはUIプリミティブ（FormField/Input/Select/Button）を使用する

### 連携サービス
- 接続状態: 接続済み/未接続/再認可が必要を表示
- 接続/切断: Google/MetaはE2Eで動作
- Google（GBP）店舗を選ぶ: 店舗詳細から選択してつなぐ
- Metaページを選ぶ: Facebookページを選択してつなぐ
- 連携バッジ: レビュー/投稿/検索などの能力を表示

### 店舗詳細（かんたん導線）
- 画面上部に「今日やること（ステップ）」を表示
- 未完了のステップは最大3件まで表示し、完了済みは折りたたむ
- 「初めての設定」と「毎日の運用」を分けて表示
- 用語は店舗オーナー向け（店舗/連携サービス/口コミ・コメント）で統一

### 初期設定（詳細チェック）
- `/app/setup` に進捗とKPIを表示
- 目的: 初見ユーザーが迷わず、実運用前の詰まりを早期に発見できる
- 状態表示:
  - 店舗数
  - 接続状態（Google/Meta）
  - 店舗を選んだ数（Google/FB）
  - 投稿回数/最終投稿/失敗件数（Google/Meta）
  - 口コミ件数/最終取り込み/直近結果/最終返信（Google）
  - 画像アップロード件数/最終アップロード（Storage）
  - 口コミのまとめ取り込みの実行結果（対象数/成功/失敗/口コミ件数）
  - 口コミの自動取り込み設定（ON/OFF・頻度・次回予定）
- 進捗:
  - 完了 X/Y と進捗率
  - 各ステップに「完了にする」チェック（owner/adminのみ保存）
  - 保存できない場合は理由を表示
  - 完了チェックの運用ルールはRunbookに従う

### 口コミ
- 店舗詳細で口コミ一覧を表示
- Google口コミの取り込み: 「取り込む」ボタンでDBへ反映する
- 口コミ返信: テキスト返信を送信できる（未承認時は案内表示）

### 口コミ・コメント受信箱
- `/app/reviews` で組織内の口コミ/コメントを横断して確認する
- 目的: 店舗をまたいだ対応を最短化する
- 権限: 組織メンバーは閲覧可、返信は既存の権限制御に従う
- 一覧はTableで表示し、Paginationでページ移動する
- 列構成:
  - 日時 / 店舗 / 連携サービス / 評価 / 本文 / 状態 / 操作 / 詳細
- 本文は2行まで省略し、詳細で全文/口コミ・コメントID/返信状況を確認できる
- フィルタ/検索/ページング:
  - 未返信のみ
  - 店舗
  - 期間
  - 自由検索（投稿者/本文/店舗名の範囲で可能な限り）
- 返信:
  - Google: 口コミ返信（既存）
  - Facebook/Instagram: 投稿コメントの返信に対応
  - DM（InstagramのDM / Facebookメッセージ）は対象外（次版）
- 実機確認:
  - diagnostics → provider-health → 受信箱の順で状態を確認する
  - 目安: Google口コミの取得/返信ができる、SNSコメントの取得/返信ができる

### 投稿
- 店舗詳細で投稿履歴を表示
- 投稿作成はGoogle/Metaで最小実装（未承認時は案内表示）
- 投稿は「テンプレ → 本文 → 投稿先 → 送信」の順で進める
- Meta投稿: Facebookは本文必須、Instagramは画像必須
- GBP投稿:
  - 本文必須、画像は任意（推奨）
- 前提: Google接続済み + 店舗を選んでいる
  - 失敗分類: 再認可 / 権限不足・API未承認 / レート制限
- 画像指定方法:
  - URL入力
  - ファイルアップロード（Supabase Storage、署名URLを利用）
- 画像の制約:
  - 形式: `image/png` / `image/jpeg` / `image/webp` / `image/gif`
  - 最大サイズ: `MAX_UPLOAD_MB`（既定10MB）
- 署名URLの期限: `MEDIA_SIGNED_URL_TTL_SECONDS`（既定3600秒）
- 投稿履歴:
  - 作成日時/本文/対象連携サービス/ステータス/エラーを表示
  - 画像は URL / storage 参照を正規化して表示
  - storage 参照は署名URLを発行してプレビュー表示
  - 署名URLは短命のため、期限切れ時は再発行する
  - 検索: 本文の部分一致（簡易検索）
  - フィルタ: 状態（成功/失敗/送信中）、対象（Facebook/Instagram/Google）
  - ページング: 1ページ10件（最大50件まで）
  - 失敗時: 原因と次にやることを分けて表示
  - 再実行: 失敗したMeta/Google投稿（接続済み/再認可が必要な場合は案内）

### 投稿テンプレ（MVP）
- `/app/post-templates` でテンプレを管理する
- 作成/編集/削除: 管理者のみ
- 利用（投稿へ反映）: 全員
- テンプレ選択で本文・投稿先の初期値が入る
- `/app/setup` にテンプレ準備カードを表示し、件数と作成導線を案内する

### 監査と履歴
- 操作は監査ログに記録される（トークンは記録しない）

## 権限要件（最小版）
- owner/admin: 店舗作成、連携サービス接続/切断、投稿/返信
- member/viewer: 参照のみ（作成不可）

## 取り込み/更新
- 手動取り込みボタン（次フェーズ）
- 期限切れ/再認可はUIで明示
- Metaは有効期限が近い場合に再認可を促す

## 受け入れ条件（Acceptance Criteria）
- ユーザー画面に「ロケーション/プロバイダ/スタブ/実機スモーク」など内部用語が表示されない
- ナビがモック準拠の構成になり、権限に応じて項目が増える
- `/app/setup` が初期設定として過不足なく、内部向けの導線が表示されない
- `/app` がダッシュボードとしてKPI/簡易グラフを表示できる
- 受信箱が「口コミ・コメント受信箱」として分かりやすい
- 店舗詳細に「今日やること」があり、未完了の項目だけが開く
- 店舗詳細のMeta投稿で「URL入力」「ファイルアップロード」を切り替えできる
- 投稿テンプレを作成し、投稿フォームに反映できる
- ファイルアップロードは private bucket に保存され、署名URLでプレビューできる
- Instagram投稿は画像必須のガードがあり、未入力時は日本語エラーが出る
- PROVIDER_MOCK_MODE=true でもアップロードUIが壊れず、モックプレビューが表示される
- 投稿履歴が表示され、ステータス/対象/エラーが判別できる
- storage 参照の画像は署名URLでプレビューできる（未設定時は利用不可を表示）
- 投稿履歴の検索/フィルタ/ページ送りができる
- 失敗カードで「原因」「次にやること」が別表示される
- Google投稿が作成でき、投稿履歴にGoogleターゲットが表示される
- Google投稿の再実行ができる（モック/実モードで分岐）
- /app/setup で進捗/KPI/完了チェックが確認できる（不明は不明と表示）
- 受信箱で未返信/店舗/期間/検索が使え、Google口コミとSNSコメントに返信できる
- diagnostics/provider-healthに受信箱の実機確認導線があり、店舗オーナー向けの案内で迷わず進められる
