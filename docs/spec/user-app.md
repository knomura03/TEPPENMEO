# ユーザーアプリ仕様（最小版）

## 目的
- テナントユーザーがロケーションとプロバイダ連携を操作できること
- レビュー/投稿の確認と基本操作の導線が分かること

## 主要画面
- ダッシュボード: `/app`
- セットアップ: `/app/setup`
- ロケーション一覧: `/app/locations`
- ロケーション詳細: `/app/locations/[id]`

## 機能要件

### ロケーション（CRUD）
- 作成: 名前は必須、住所/緯度/経度は任意
- 参照: ロケーション一覧と詳細の表示
- 更新/削除: 次フェーズで追加
- フォーム/ボタンはUIプリミティブ（FormField/Input/Select/Button）を使用する

### プロバイダ連携
- 接続状態: 接続済み/未接続/再認可が必要を表示
- 接続/切断: Google/MetaはE2Eで動作
- GBPロケーション紐付け: ロケーション詳細から選択して紐付ける
- Metaページ紐付け: Facebookページを選択して紐付ける
- 連携バッジ: レビュー/投稿/検索などの能力を表示

### セットアップ（詳細チェック）
- `/app/setup` に進捗とKPIを表示
- 目的: 初見ユーザーが迷わず、実運用前の詰まりを早期に発見できる
- 状態表示:
  - ロケーション数
  - 接続状態（Google/Meta）
  - 紐付け数（GBP/FB）
  - 投稿回数/最終投稿/失敗件数（Google/Meta）
  - レビュー件数/最終同期/直近結果/最終返信（Google）
  - 画像アップロード件数/最終アップロード（Storage）
  - GBPレビュー一括同期の実行結果（対象数/成功/失敗/レビュー件数）
  - GBPレビュー一括同期の自動同期設定（ON/OFF・頻度・次回予定）
- 進捗:
  - 完了 X/Y と進捗率
  - 各ステップに「完了にする」チェック（owner/adminのみ保存）
  - 保存できない場合は理由を表示
  - 完了チェックの運用ルールはRunbookに従う

### レビュー
- ロケーション詳細でレビュー一覧を表示
- GBPレビュー同期: 「レビュー同期」ボタンでDBへ同期する
- レビュー返信: テキスト返信を送信できる（未承認時は案内表示）

### レビュー受信箱
- `/app/reviews` で組織内レビューを横断して確認する
- 目的: ロケーションをまたいだレビュー対応を最短化する
- 権限: 組織メンバーは閲覧可、返信は既存の権限制御に従う
- 一覧はTableで表示し、Paginationでページ移動する
- 列構成:
  - 日時 / ロケーション / プロバイダ / 評価 / 本文 / 状態 / 操作 / 詳細
- 本文は2行まで省略し、詳細で全文/レビューID/返信状況を確認できる
- フィルタ/検索/ページング:
  - 未返信のみ
  - ロケーション
  - 期間
  - 自由検索（投稿者/本文/ロケーション名の範囲で可能な限り）
- 返信:
  - Googleのみ対応（GBP）
  - Metaは未対応と明記する

### 投稿
- ロケーション詳細で投稿履歴を表示
- 投稿作成はGoogle/Metaで最小実装（未承認時は案内表示）
- Meta投稿: Facebookは本文必須、Instagramは画像必須
- GBP投稿:
  - 本文必須、画像は任意（推奨）
  - 前提: Google接続済み + GBPロケーション紐付け済み
  - 失敗分類: 再認可 / 権限不足・API未承認 / レート制限
- 画像指定方法:
  - URL入力
  - ファイルアップロード（Supabase Storage、署名URLを利用）
- 画像の制約:
  - 形式: `image/png` / `image/jpeg` / `image/webp` / `image/gif`
  - 最大サイズ: `MAX_UPLOAD_MB`（既定10MB）
- 署名URLの期限: `MEDIA_SIGNED_URL_TTL_SECONDS`（既定3600秒）
- 投稿履歴:
  - 作成日時/本文/対象プロバイダ/ステータス/エラーを表示
  - 画像は URL / storage 参照を正規化して表示
  - storage 参照は署名URLを発行してプレビュー表示
  - 署名URLは短命のため、期限切れ時は再発行する
  - 検索: 本文の部分一致（簡易検索）
  - フィルタ: 状態（成功/失敗/送信中）、対象（Facebook/Instagram/Google）
  - ページング: 1ページ10件（最大50件まで）
  - 失敗時: 原因と次にやることを分けて表示
  - 再実行: 失敗したMeta/Google投稿（接続済み/再認可が必要な場合は案内）

### 監査と履歴
- 操作は監査ログに記録される（トークンは記録しない）

## 権限要件（最小版）
- owner/admin: ロケーション作成、プロバイダ接続/切断、投稿/返信
- member/viewer: 参照のみ（作成不可）

## 同期/更新
- 手動同期ボタン（次フェーズ）
- 期限切れ/再認可はUIで明示
- Metaは有効期限が近い場合に再認可を促す

## 受け入れ条件（Acceptance Criteria）
- ロケーション詳細のMeta投稿で「URL入力」「ファイルアップロード」を切り替えできる
- ファイルアップロードは private bucket に保存され、署名URLでプレビューできる
- Instagram投稿は画像必須のガードがあり、未入力時は日本語エラーが出る
- PROVIDER_MOCK_MODE=true でもアップロードUIが壊れず、モックプレビューが表示される
- 投稿履歴が表示され、ステータス/対象/エラーが判別できる
- storage 参照の画像は署名URLでプレビューできる（未設定時は利用不可を表示）
- 投稿履歴の検索/フィルタ/ページ送りができる
- 失敗カードで「原因」「次にやること」が別表示される
- Google投稿が作成でき、投稿履歴にGoogleターゲットが表示される
- Google投稿の再実行ができる（モック/実モードで分岐）
- /app/setup で進捗/KPI/完了チェックが確認できる（不明は不明と表示）
- レビュー受信箱で未返信/ロケーション/期間/検索が使え、Googleレビュー返信ができる
