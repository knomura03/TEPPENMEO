# 管理アプリ仕様（最小版）

## 目的
- システム全体の状態把握と安全運用を支援する
- プロバイダ設定/監査ログ/診断情報を一元管理する

## 主要画面
- 管理概要: `/admin`
- プロバイダ管理: `/admin/providers`
- 監査ログ: `/admin/audit-logs`
- 診断: `/admin/diagnostics`
- ユーザー管理: `/admin/users`
- 組織一覧: `/admin/organizations`
- 組織メンバー管理: `/admin/organizations/[id]`

## 機能要件

### プロバイダ管理
- 有効/無効、モック/スタブ/有効の状態表示
- 必要な環境変数の有無を案内

### 監査ログ
- 目的: 事故調査・運用確認・再発防止のための操作履歴を確認する
- 接続/切断/再認可要求などの操作履歴を表示
- 操作主体・対象・時刻を可視化
- フィルタ要件:
  - 期間（from/to）
  - action
  - 組織（organization）
  - 操作者（actor）
  - provider_type
  - free text（metadata_json内の軽い検索。難しい場合はaction/targetに限定）
- 記録して良い情報:
  - 操作種別、対象ID、非機密の補足情報、原因の要約
- 記録してはいけない情報:
  - トークン/鍵/招待リンクなどの機密
  - パスワードや個人情報（必要最小限のメールのみ）

### 診断
- 必須環境変数の設定有無（値は非表示）
- Supabase接続の簡易判定
- PROVIDER_MOCK_MODE の状態
- Google接続状態（接続済み/未接続/再認可）
- 次にやることの提示

### ユーザー管理
- ユーザー一覧/検索（メールでフィルタ）
- 状態フィルタ（有効/招待中/無効）
- 組織フィルタ（所属組織）
- ユーザー作成（招待メール/招待リンク/仮パスワード方式）
- 招待メール失敗時は招待リンクで継続できる
- 招待テンプレ（件名/本文）を生成してコピーできる
- 組織への追加（ロール付与）
- ロール変更
- 組織から削除（メンバー解除）
- ユーザー無効化/再有効化（Supabase ban + アプリ側ブロック）
- 無効化理由を記録し、利用停止画面に表示できる（任意）
- ユーザー削除（危険操作は2段階確認）
- 無効化ユーザーはアプリにアクセスできない
- `user_blocks` マイグレーション未適用時は警告し操作を制限する

## 権限要件
- system_admin のみ閲覧/操作可能

## 監査方針
- 変更系操作は必ず記録
- トークン/秘密情報は記録しない

## 受け入れ条件（Acceptance Criteria）
- システム管理者のみがユーザー/組織管理にアクセスできる
- ユーザー作成・招待メール/リンク・仮パスワード発行が実行できる
- 招待テンプレで件名/本文をコピーできる
- 組織への追加/ロール変更/削除が実行できる
- 無効化/再有効化が実行でき、無効化ユーザーはアクセス不可になる
- 無効化理由が監査ログに記録され、利用停止画面に表示できる
- 危険操作は2段階確認が必須
- すべての操作が監査ログに記録される
- 監査ログで期間・action・組織・操作者・provider_type・free textで検索できる
- 監査ログの表示が読みやすく、失敗はバッジで判別できる
