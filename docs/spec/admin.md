# 管理アプリ仕様（最小版）

## 目的
- システム全体の状態把握と安全運用を支援する
- プロバイダ設定/監査ログ/診断情報を一元管理する

## 主要画面
- 管理概要: `/admin`
- プロバイダ管理: `/admin/providers`
- 監査ログ: `/admin/audit-logs`
- 診断: `/admin/diagnostics`
- 実機ヘルスチェック: `/admin/provider-health`
- ユーザー管理: `/admin/users`
- 組織一覧: `/admin/organizations`
- 組織メンバー管理: `/admin/organizations/[id]`
- リリース準備: `/admin/release`

## 機能要件

### プロバイダ管理
- 有効/無効、モック/スタブ/有効の状態表示
- 必要な環境変数の有無を案内

### 監査ログ
- 目的: 事故調査・運用確認・再発防止のための操作履歴を確認する
- 接続/切断/再認可要求などの操作履歴を表示
- 操作主体・対象・時刻を可視化
- 列構成:
  - 日時 / 操作 / 組織 / 操作者 / 対象 / プロバイダ / 状態 / 追加情報 / 詳細
- 詳細:
  - metadata/targetId/actorUserId を表示
  - metadata はKey/Valueで表示し、機密キーはマスクする
- フィルタ要件:
  - 期間（from/to）
  - action
  - 組織（organization）
  - 操作者（actor）
  - provider_type
  - free text（metadata_json内の軽い検索。難しい場合はaction/targetに限定）
- 記録して良い情報:
  - 操作種別、対象ID、非機密の補足情報、原因の要約
- 記録してはいけない情報:
  - トークン/鍵/招待リンクなどの機密
  - パスワードや個人情報（必要最小限のメールのみ）
- CSVエクスポート:
  - 現在のフィルタ条件でCSVを出力できる
  - システム管理者のみ実行可能
  - 最高件数を上限付きで制御（超過時は条件を絞る）
  - 機密キーはマスキングして出力
- 保存期間/アーカイブ:
  - 推奨保持期間を定める
  - CSV退避後に削除できる運用を想定

### 診断
- 必須環境変数の設定有無（値は非表示）
- Supabase接続の簡易判定
- PROVIDER_MOCK_MODE の状態
- Google接続状態（接続済み/未接続/再認可）
- 次にやることの提示

### 実機ヘルスチェック
- 読み取り系APIで接続状態を検証する
- 失敗時は原因（推定）と次アクションを提示する
- 監査ログに成功/失敗と推定理由を記録する

### ユーザー管理
- ユーザー一覧/検索（メールでフィルタ）
- 状態フィルタ（有効/招待中/無効）
- 組織フィルタ（所属組織）
- 列構成:
  - メール / 作成日 / 所属組織数 / システム管理 / 状態 / 操作 / 詳細
- 詳細:
  - ユーザーID、作成日、招待日時、最終ログイン、状態を確認できる
- ユーザー作成（招待メール/招待リンク/仮パスワード方式）
- 招待メール失敗時は招待リンクで継続できる
- 招待テンプレ（件名/本文）を生成してコピーできる
- 組織への追加（ロール付与）
- ロール変更
- 組織から削除（メンバー解除）
- システム管理者の付与/解除（システム管理者のみ、確認入力必須）
- ユーザー無効化/再有効化（Supabase ban + アプリ側ブロック）
- 無効化理由を記録し、利用停止画面に表示できる（任意）
- ユーザー削除（危険操作は2段階確認）
- 無効化ユーザーはアプリにアクセスできない
- `user_blocks` マイグレーション未適用時は警告し操作を制限する

### ジョブ履歴
- 一括同期などの実行履歴を確認する
- 列構成:
  - ジョブ / 組織 / 状態 / 開始 / 終了 / 対象数 / 成功 / 失敗 / レビュー件数 / 詳細
- 詳細:
  - summary/error を確認でき、機密キーはマスクする

### リリース準備ダッシュボード
- 目的: リリース前に必要な設定・権限・公開情報を1画面で確認する
- 表示要素（値は出さず、設定済み/未設定のみ）
  - 環境: mock/real、APP_BASE_URL、PUBLIC_*（運営者/連絡先）
  - Supabase: 接続可否、マイグレーション適用状況
  - Storage/Cron/Jobs: バケット設定、サービスキー、CRON_SECRET、自動同期ON数
  - 登録情報テンプレ: Redirect URI / 公開ページURL のテンプレ表示（<APP_BASE_URL>）
  - Providers: Google/Meta 接続状態と権限差分（保存済み情報ベース）
  - 実機の動作確認: 口コミ取得/返信、投稿、画像アップロードの最終成功時刻（未実施/未判定は明示）
  - 実機スモーク: Runbookリンクと合格基準
  - 証跡テンプレ: preflight/provider-health/スモークの貼り付けテンプレへのリンク
- 導線:
  - 診断・実機ヘルス・リリースRunbook・スモークRunbook・各プロバイダ審査Runbookへのリンク
  - staging CLI手順（`docs/runbooks/staging-cli-bootstrap.md`）へのリンク
- 権限:
  - システム管理者のみアクセス可能
- 受け入れ条件:
  - 値は表示せず「設定済み/未設定」「OK/注意」を示す
  - 各セクションに「次にやること」リンクがある
  - /admin/diagnostics から遷移できる

## 権限要件
- システム管理者のみ閲覧/操作可能

## 権限モデル
- 参照: `docs/runbooks/permissions-model.md`

## 管理画面のUI規約（global-design準拠）
- 参照: `docs/global-design.md`
- 対象画面: `/admin`, `/admin/diagnostics`, `/admin/users`, `/admin/audit-logs`, `/admin/jobs`, `/admin/provider-health`
- ルール:
  - 本文は16px基準、14pxは例外扱いにする
  - フィルタバー/カード/テーブルの余白を統一し、行間と見出し階層を揃える
  - 状態表示はバッジ＋テキストで示し、色だけに依存しない
  - 0件/未設定/未適用は EmptyState/Callout を使う
  - 警告/エラーは「原因」「次にやること」「手順書リンク」を必ず出す
  - ボタンは最小44pxの押下領域を確保する
  - UI変更を含むPRはPlaywrightスクショを更新し、PR本文にスクショ名を記載する

## 監査方針
- 変更系操作は必ず記録
- トークン/秘密情報は記録しない

## 受け入れ条件（Acceptance Criteria）
- システム管理者のみがユーザー/組織管理にアクセスできる
- ユーザー作成・招待メール/リンク・仮パスワード発行が実行できる
- 招待テンプレで件名/本文をコピーできる
- 組織への追加/ロール変更/削除が実行できる
- 無効化/再有効化が実行でき、無効化ユーザーはアクセス不可になる
- 無効化理由が監査ログに記録され、利用停止画面に表示できる
- 危険操作は2段階確認が必須
- すべての操作が監査ログに記録される
- 監査ログで期間・action・組織・操作者・provider_type・free textで検索できる
- 監査ログの表示が読みやすく、失敗はバッジで判別できる
- 監査ログCSVをダウンロードでき、機密が出力されない
- 保持期間とアーカイブ方針が手順書で明文化されている
- 実機ヘルスチェックでGoogle/Metaの読み取りAPIが確認できる
